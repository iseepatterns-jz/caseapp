# AWS Deployment Guide

## Overview

This guide covers the complete deployment process for the Court Case Management System on AWS using Infrastructure as Code (CDK) and automated CI/CD pipelines.

## Architecture

The system deploys on AWS with the following components:

- **ECS Fargate**: Containerized application hosting
- **RDS PostgreSQL**: Primary database with encryption
- **ElastiCache Redis**: Session and caching layer
- **OpenSearch**: Document search and analytics
- **S3**: Document and media storage with lifecycle policies
- **Cognito**: User authentication and authorization
- **CloudFront**: CDN for static assets
- **Application Load Balancer**: Traffic distribution and SSL termination

## Prerequisites

### AWS Account Setup

1. **AWS Account**: Ensure you have an AWS account with appropriate permissions
2. **AWS CLI**: Install and configure AWS CLI v2
   ```bash
   aws configure
   ```
3. **CDK CLI**: Install AWS CDK CLI
   ```bash
   npm install -g aws-cdk
   ```
4. **Docker**: Ensure Docker is installed and running

### GitHub Repository Setup

The following secrets must be configured in your GitHub repository:

#### Required Secrets

- `DOCKER_USERNAME`: Docker Hub username
- `DOCKER_PASSWORD`: Docker Hub password or access token
- `AWS_ACCESS_KEY_ID`: AWS access key for deployment
- `AWS_SECRET_ACCESS_KEY`: AWS secret access key for deployment

#### Optional Secrets (for enhanced features)

- `SLACK_WEBHOOK_URL`: For deployment notifications
- `DATADOG_API_KEY`: For monitoring integration

## Deployment Methods

### Method 1: Automated CI/CD (Recommended)

The system includes a complete GitHub Actions workflow that automatically:

1. **Tests**: Runs all backend tests with PostgreSQL and Redis
2. **Security Scanning**: Scans Docker images for vulnerabilities
3. **Build & Push**: Builds and pushes Docker images to Docker Hub
4. **Deploy**: Deploys infrastructure and applications to AWS
5. **Validate**: Performs post-deployment health checks

#### Triggering Deployment

- **Staging**: Push to `develop` branch
- **Production**: Push to `main` branch

### Method 2: Manual Deployment

For manual deployment or troubleshooting:

```bash
# Navigate to the application directory
cd caseapp

# Make deployment script executable
chmod +x scripts/deploy-aws.sh

# Run deployment
./scripts/deploy-aws.sh deploy
```

## Deployment Process

### 1. Infrastructure Provisioning

The CDK stack creates:

- **VPC**: Multi-AZ setup with public, private, and database subnets
- **Security Groups**: Properly configured for each service
- **RDS**: PostgreSQL 15 with encryption and automated backups
- **ElastiCache**: Redis cluster for caching
- **OpenSearch**: Document search cluster
- **S3 Buckets**: Separate buckets for documents and media with lifecycle policies
- **ECS Cluster**: Fargate-based container orchestration
- **Cognito**: User pool with MFA enabled
- **IAM Roles**: Least-privilege access for all services

### 2. Application Deployment

- **Backend Service**: FastAPI application with auto-scaling
- **Media Processor**: Dedicated service for audio/video processing
- **Database Migrations**: Automated schema deployment
- **Health Checks**: Comprehensive monitoring setup

### 3. Post-Deployment Configuration

After successful deployment:

1. **Database Setup**: Run initial migrations
2. **Admin User**: Create first administrative user
3. **AI Services**: Validate Bedrock and other AI integrations
4. **Monitoring**: Configure CloudWatch dashboards and alarms

## Environment Configuration

### Production Environment Variables

Key environment variables configured automatically:

```bash
# AWS Services
AWS_REGION=us-east-1
S3_BUCKET_NAME=court-case-documents
S3_MEDIA_BUCKET=court-case-media
OPENSEARCH_ENDPOINT=<auto-generated>

# Database
DATABASE_URL=<from-secrets-manager>

# Authentication
COGNITO_USER_POOL_ID=<auto-generated>
COGNITO_CLIENT_ID=<auto-generated>

# AI Features
ENABLE_AI_FEATURES=true
BEDROCK_REGION=us-east-1
```

## Monitoring and Observability

### CloudWatch Integration

- **Application Logs**: Centralized logging with retention policies
- **Metrics**: Custom application metrics and AWS service metrics
- **Alarms**: Automated alerting for critical issues
- **Dashboards**: Real-time monitoring views

### Health Checks

The system includes comprehensive health checks:

- **Application Health**: `/health` endpoint
- **Database Connectivity**: Connection pool status
- **External Services**: AI services availability
- **Storage Access**: S3 and OpenSearch connectivity

## Security Features

### Data Protection

- **Encryption at Rest**: All data stores encrypted
- **Encryption in Transit**: TLS 1.2+ for all communications
- **Secrets Management**: AWS Secrets Manager integration
- **Network Security**: VPC with private subnets for databases

### Access Control

- **IAM Roles**: Least-privilege access patterns
- **Security Groups**: Restrictive network access
- **Cognito MFA**: Multi-factor authentication required
- **API Authentication**: JWT-based API security

## Scaling and Performance

### Auto Scaling

- **ECS Services**: CPU and memory-based scaling
- **RDS**: Read replicas for high-traffic scenarios
- **ElastiCache**: Cluster mode for distributed caching

### Performance Optimization

- **CDN**: CloudFront for static asset delivery
- **Database**: Connection pooling and query optimization
- **Caching**: Multi-layer caching strategy
- **Media Processing**: Asynchronous processing pipeline

## Cost Optimization

### Resource Efficiency

- **Right-sizing**: Appropriately sized instances for workload
- **Lifecycle Policies**: Automated data archiving
- **Spot Instances**: Cost-effective compute where applicable
- **Reserved Capacity**: Long-term cost savings for predictable workloads

## Troubleshooting

### Common Issues

1. **CDK Bootstrap**: Ensure CDK is bootstrapped in target region
2. **Docker Build**: Verify Dockerfile and build context
3. **Database Connection**: Check security group rules
4. **Health Checks**: Validate application startup time

### Debugging Commands

```bash
# Check deployment status
./scripts/deploy-aws.sh outputs

# View infrastructure diff
./scripts/deploy-aws.sh diff

# Destroy infrastructure (use with caution)
./scripts/deploy-aws.sh destroy
```

### Log Access

```bash
# View ECS service logs
aws logs tail /ecs/backend --follow

# View deployment logs
aws logs tail /aws/codebuild/court-case-deployment --follow
```

## Disaster Recovery

### Backup Strategy

- **Database**: Automated daily backups with 7-day retention
- **Documents**: S3 versioning and cross-region replication
- **Configuration**: Infrastructure as Code for rapid rebuilding

### Recovery Procedures

1. **Database Recovery**: Point-in-time restore from RDS backups
2. **Application Recovery**: Redeploy from latest Docker images
3. **Data Recovery**: Restore from S3 versioned objects

## Compliance and Auditing

### HIPAA Compliance

- **Encryption**: All data encrypted at rest and in transit
- **Access Logging**: Comprehensive audit trails
- **User Management**: Proper authentication and authorization
- **Data Retention**: Configurable retention policies

### SOC 2 Controls

- **Security**: Multi-layered security controls
- **Availability**: High availability architecture
- **Processing Integrity**: Data validation and integrity checks
- **Confidentiality**: Access controls and encryption
- **Privacy**: Data handling and user consent management

## Support and Maintenance

### Regular Maintenance

- **Security Updates**: Automated patching for managed services
- **Dependency Updates**: Regular updates to application dependencies
- **Performance Monitoring**: Continuous performance optimization
- **Cost Review**: Monthly cost analysis and optimization

### Support Contacts

For deployment issues or questions:

1. Check the deployment logs in GitHub Actions
2. Review CloudWatch logs for runtime issues
3. Consult the troubleshooting section above
4. Contact the development team for complex issues

## Next Steps

After successful deployment:

1. **Domain Setup**: Configure custom domain name
2. **SSL Certificate**: Attach SSL certificate to load balancer
3. **Monitoring Setup**: Configure additional monitoring and alerting
4. **User Training**: Provide training for end users
5. **Documentation**: Update any organization-specific documentation
